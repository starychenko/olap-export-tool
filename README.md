# OLAP Експорт даних

Скрипт `olap.py` призначений для підключення до OLAP-кубу, виконання MDX-запитів та експорту отриманих даних у формат Excel з автоматичним форматуванням.

## Особливості

- Підключення до OLAP-кубу з Windows-аутентифікацією
- Виконання MDX-запитів по періодам (рік/тиждень)
- Анімований індикатор прогресу при виконанні запитів та отриманні даних
- Експорт даних до Excel з автоматичним форматуванням (кольори, шрифти, ширина стовпців)
- Обробка декількох тижнів за один запуск
- Затримка між запитами для зниження навантаження на OLAP
- Структурована організація файлів (по роках та періодах)
- Кольоровий вивід у консоль для кращого відображення статусу операцій

## Вимоги

### Програмне забезпечення
- Python 3.7 або вище
- Microsoft SQL Server Management Studio (SSMS)
- Бібліотека ADOMD.NET (Microsoft.AnalysisServices.AdomdClient.dll)

### Бібліотеки Python
Всі необхідні бібліотеки перелічені в файлі `requirements.txt`. Для встановлення:

```
pip install -r requirements.txt
```

## Налаштування ADOMD.NET

Для роботи скрипту необхідно встановити та налаштувати бібліотеку ADOMD.NET:

1. **Встановлення ADOMD.NET**:
   - Найпростіший спосіб — встановити Microsoft SQL Server Management Studio (SSMS)
     - Офіційна сторінка завантаження: [Download SQL Server Management Studio (SSMS)](https://learn.microsoft.com/en-us/ssms/download-sql-server-management-studio-ssms#download-ssms)
     - Пряме посилання на завантаження: [SSMS Full Setup](https://aka.ms/ssmsfullsetup)
   - Альтернативно можна завантажити окремо [Microsoft Analysis Services ADOMD.NET](https://docs.microsoft.com/en-us/analysis-services/client-libraries?view=asallproducts-allversions)

2. **Перевірка наявності бібліотеки**:
   Після встановлення SSMS бібліотека повинна знаходитись за шляхом:
   ```
   C:\Program Files (x86)\Microsoft SQL Server Management Studio 20\Common7\IDE\CommonExtensions\Microsoft\SSIS\160\BIShared
   ```
   або за подібним шляхом в залежності від версії SSMS.

3. **Налаштування шляху**:
   Вкажіть правильний шлях до бібліотеки у файлі `.env`:
   ```
   ADOMD_DLL_PATH=C:\Program Files (x86)\Microsoft SQL Server Management Studio 20\Common7\IDE\CommonExtensions\Microsoft\SSIS\160\BIShared
   ```

## Налаштування параметрів

1. Створіть файл `.env` в корені проекту зі змінними середовища:

```
# Параметри підключення
OLAP_SERVER=10.40.0.48
OLAP_DATABASE=Sells

# Параметри запиту
FILTER_FG1_NAME=Споживча електроніка

# Періоди запитів (у форматі РРРР-ТТ, де РРРР - рік, ТТ - номер тижня)
YEAR_WEEK_START=2024-50
YEAR_WEEK_END=2025-03

# Затримка між запитами (у секундах)
QUERY_TIMEOUT=30

# Шлях до бібліотеки ADOMD.NET
ADOMD_DLL_PATH=C:\Program Files (x86)\Microsoft SQL Server Management Studio 20\Common7\IDE\CommonExtensions\Microsoft\SSIS\160\BIShared

# Налаштування форматування Excel
EXCEL_HEADER_COLOR=00365E
EXCEL_HEADER_FONT_COLOR=FFFFFF
EXCEL_HEADER_FONT_SIZE=11
```

2. Відредагуйте змінні `year_num` та `week_nums` у файлі `olap.py` для вказання періоду:

```python
# Задаємо значення для року та списку тижнів, які хочемо обробити
year_num = 2025
week_nums = [8, 9, 10]  # Список тижнів для обробки
```

## Запуск скрипту

Для запуску скрипту виконайте команду:

```
python olap.py
```

Результати будуть збережені у директорії `result/[рік]/[рік]-[тиждень].xlsx`

## Структура проекту

```
project/
│
├── olap.py            # Основний скрипт
├── .env               # Файл змінних середовища
├── requirements.txt   # Залежності Python
├── README.md          # Документація
├── setup.ps1          # Скрипт налаштування для Windows (англійською)
├── setup_ukr.ps1      # Скрипт налаштування для Windows (українською)
├── setup.sh           # Скрипт налаштування для Linux/MacOS
│
└── result/            # Каталог з результатами
    └── [рік]/         # Підкаталог з роком
        └── [рік]-[тиждень].xlsx  # Файли Excel з результатами
```

## Розширені налаштування

### Налаштування періодів для обробки

Скрипт підтримує два способи вказання періодів для обробки:

1. **Через змінні у файлі olap.py**:
   ```python
   year_num = 2025
   week_nums = [8, 9, 10]  # Список тижнів для обробки
   ```
   Цей спосіб використовується, якщо всі тижні належать до одного року.

2. **Через змінні середовища у файлі .env**:
   ```
   YEAR_WEEK_START=2024-50
   YEAR_WEEK_END=2025-03
   ```
   Цей спосіб дозволяє обробляти періоди, що охоплюють декілька років. Скрипт автоматично згенерує всі проміжні тижні між початковим і кінцевим періодами.

### Налаштування MDX-запиту

MDX-запит можна налаштувати безпосередньо у файлі `olap.py`, змінивши змінну `query` у функції `process_week()`.

### Анімований індикатор прогресу

Скрипт використовує анімований індикатор прогресу для відображення активності під час виконання довготривалих операцій:
- Під час отримання даних з OLAP-кубу відображається спіннер з часом виконання
- Між запитами відображається зворотній відлік для кращого розуміння часу до наступної операції
- Кольоровий вивід різних типів повідомлень (інформація, попередження, помилки, успіх)

### Налаштування форматування Excel

Параметри форматування Excel-файлу налаштовуються через змінні середовища у файлі `.env`:

- `EXCEL_HEADER_COLOR` - колір фону заголовків (hex-код без #)
- `EXCEL_HEADER_FONT_COLOR` - колір шрифту заголовків (hex-код без #)
- `EXCEL_HEADER_FONT_SIZE` - розмір шрифту заголовків 

## Автоматична підготовка середовища

Для спрощення процесу налаштування середовища та встановлення залежностей, додано автоматизовані скрипти:

### Для Windows (PowerShell)

Для автоматичного налаштування середовища в Windows:

1. Відкрийте PowerShell
2. Перейдіть у директорію проекту
3. Запустіть скрипт налаштування:
   ```powershell
   .\setup.ps1   # Англомовний інтерфейс
   ```
   або
   ```powershell
   .\setup_ukr.ps1   # Україномовний інтерфейс
   ```

Скрипт автоматично:
- Перевірить наявність Python
- Створить віртуальне середовище
- Встановить усі необхідні залежності
- Підготує файл `.env` з шаблону `env.example` (якщо необхідно)

### Для Linux/MacOS (Bash)

Для автоматичного налаштування середовища в Linux або MacOS:

1. Відкрийте термінал
2. Перейдіть у директорію проекту
3. Зробіть скрипт виконуваним та запустіть його:
   ```bash
   chmod +x setup.sh
   ./setup.sh
   ```

Скрипт також виконає повне налаштування середовища.

### Можливості скриптів налаштування

Обидва скрипти мають додаткові можливості:
- Виявлення та використання існуючих віртуальних середовищ
- Опція перестворення середовища з нуля
- Перевстановлення залежностей у існуючому середовищі
- Автоматичне налаштування `.env` файлу з шаблону
- Кольоровий інтерактивний інтерфейс для зручності використання 